name: Update Serving Model

on: workflow_dispatch

#defaults:
#  run:
#    working-directory: bert-tf-serving

jobs:

  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: checkout
      uses: actions/checkout@v1
      
    - name: Copy model config
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DEPLOYMENT_HOST_TF_SERVING }}
        username: ec2-user
        port: 22
        key: ${{ secrets.SSH_KEY_TF_SERVING }}
        source: "bert-tf-serving/models.config"
        target: "/home/ec2-user/model"
        strip_components: 1
    
    - name: executing remote ssh commands using ssh key
      uses: appleboy/ssh-action@master   
      with:
        host: ${{secrets.DEPLOYMENT_HOST_TF_SERVING}}
        username: ec2-user
        key: ${{ secrets.SSH_KEY_TF_SERVING }}
        port: 22
        envs: GITHUB_SHA
        script: |
          echo "Hi Hi"
          docker stop bert-tf-serving
          docker rm bert-tf-serving
          docker run \
            --name bert-tf-serving \
            -p 8501:8501 \
            --mount type=bind,source=/home/ec2-user/model/saved_model_bert,target=/models/bert \
            --mount type=bind,source=/home/ec2-user/model/models.config,target=/models/models.config \
            -e  MODEL_NAME=bert \
            -t tensorflow/serving \
            --model_config_file=/models/models.config 
